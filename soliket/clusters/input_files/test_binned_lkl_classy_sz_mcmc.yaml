# Direction:
# download sim-kit_NemoCCL_A10tSZ_DR5White_ACT-DR5_tenToA0Tuned from https://astro.ukzn.ac.za/~mjh/ACT/DR5CosmoSims/distribution/
# put in soliket/clusters/data/advact/DR5CosmoSims directory.


# run from SOLikeT/soliket/clusters
# command:
# $ cobaya-run input_files/test_binned_lkl_ccl.yaml -f
output: chains/test_binned_classy_sz_mcmc

likelihood:
  soliket.BinnedClusterLikelihood:
    stop_at_error: True
    verbose: False
    debug: False

    # Data
    data:
      data_path: 'data/advact/DR5CosmoSims/sim-kit_NemoCCL_A10tSZ_DR5White_ACT-DR5_tenToA0Tuned/NemoCCL_A10tSZ_DR5White_ACT-DR5_tenToA0Tuned/' # Path to data directory
      cat_file: 'NemoCCL_A10tSZ_DR5White_ACT-DR5_tenToA0Tuned_mass.fits' # Path to cluster catalog file
      # data_path: 'data/advact/DR5CosmoSims/sim-kit_NemoCCL_A10tSZ_DR5White_ACT-DR5/NemoCCL_A10tSZ_DR5White_ACT-DR5/'
      # cat_file: 'NemoCCL_A10tSZ_DR5White_ACT-DR5_mass.fits'
      Q_file: 'selFn/QFit.fits' # Path to Q function file
      tile_file: 'selFn/tileAreas.txt' # Path to tile file
      rms_file: 'selFn/RMSTab.fits' # Path to RMS file

    # Theory
    theorypred:
      choose_theory: "classy_sz"
      massfunc_mode: 'ccl'
      md_hmf: '200c'
      md_ym: '200c'
      compl_mode: 'erf_diff'
      rel_correction: False # Relativistic corrections for tSZ

    # Y-M relation
    YM:
      Mpivot: 4.25e14 # Mpivot in Y-M relation

    # Selection function
    selfunc:
      SNRcut : 5. # S/N cutoff in number counts
      # Model for selection function, possibilities are
      method: 'SNRbased'
      # method: SNRbased / injection
      #   SNRbased: completeness based in SNR estimates
      #   injection: estimate completeness using source injection method from nemo (i.e. no Q)
      whichQ: 'fit'
      # whichQ: fit / injection
      #   fit : using Q fit data
      #   injection : using Q source injection data
      resolution : 'downsample'
      # resolution: full / downsample
      #   downsample: average rms map, Q into n dwnsmpl_bins
      #   full: consider full map, Q function, no downsampling
      dwnsmpl_bins : 30 # If resolution=downsample, number of bins to use
      save_dwsmpld : False # Save downsampled Q and rms to npz file and once it exists read those

      debiasDOF : 0.
      debias_cutoff: 0.
    binning:
      # redshift bins for number counts
      z:
        zmin: 0.
        zmax: 2.5 #2.6 # for a new sim
        dz: 0.1
      # SNR bins for number counts
      q:
        log10qmin: 0.6
        log10qmax: 2.0
        dlog10q: 0.25 #1.5 for one bin
      # mass bins for number counts
      M:
        Mmin: 5e13
        Mmax: 1e16
        dlogM: 0.01
      # when excluding low redshift bins for lkl, otherwise should be 0
      exclude_zbin: 0

params:
  logA:
    latex: ln10^{10}A_s
    prior:
      max: 3.4999
      min: 2.5111
    proposal: 0.12892144
    ref:
      dist: norm
      loc: 2.9939341
      scale: 0.12892144
  n_s: 0.965
  omega_b:  0.0224
  omega_cdm:
    latex: \Omega_\mathrm{c} h^2
    prior:
      max: 0.199
      min: 0.0811
    proposal: 0.0005
    ref:
      dist: norm
      loc: 0.12
      scale: 0.001
  H0:
    latex: H_0
    prior:
      max: 90.0
      min: 50.0
    proposal: 2.0
    ref:
      dist: norm
      loc: 69.351243
      scale: 2.0
  tau_reio: 0.055

  tenToA0 :
    latex: A_{ym}
    prior:
      max: 5e-5
      min: 0.5e-5
    proposal: 0.1e-5
    ref:
      dist: norm
      loc: 1.9e-5
      scale: 0.1e-5

  B0 : 0.08
  scatter_sz : 0.2
  bias_sz : 1
  # m_nu : 0.
  C0: 0.

  sigma8:
    latex: \sigma_8
    derived: true
  omegam:
    latex: \Omega_\mathrm{m}
    derived: true

sampler:
  # evaluate:
  #     override:
  #       H0: 70.
  mcmc:
    burn_in: 0
    max_tries: 10000
    # covmat: auto
    # covmat_params: null
    proposal_scale: 1.9
    output_every: 60s
    learn_every: 40d
    learn_proposal: true
    learn_proposal_Rminus1_max: 100.0
    learn_proposal_Rminus1_max_early: 100.0
    learn_proposal_Rminus1_min: 0.0
    max_samples: .inf
    Rminus1_stop: 0.01
    Rminus1_cl_stop: 0.2
    Rminus1_cl_level: 0.95
    Rminus1_single_split: 4
    measure_speeds: true
    oversample_power: 0.4
    oversample_thin: true
    drag: false
    callback_function: null
    callback_every: null
    seed: null
    check_every: null
    oversample: null
    drag_limits: null
    fallback_covmat_scale: 4
theory:
  classy_szfast.classy_sz.classy_sz:
    use_class_sz_fast_mode : 1
    stop_at_error: True
    extra_args:
      output: 'sz_cluster_counts,m500c_to_m200c,m200c_to_m500'

      mass function  : 'T08M200c'
      concentration parameter : 'B13'
      skip_background_and_thermo: 0



      B : 1.

      N_ncdm : 1
      N_ur : 2.0328
      m_ncdm : 0.06
      T_ncdm : 0.71611

      z_min: 0.
      z_max: 2.5
      redshift_epsrel: 1e-6
      redshift_epsabs: 1e-100



      M_min: 1e13
      M_max: 1e16
      mass_epsrel: 1e-6
      mass_epsabs: 1e-100
      ndim_redshifts : 100
      n_m_dndlnM : 100
      n_z_dndlnM : 100



      has_selection_function : 1
      experiment : 1
      y_m_relation : 1
      signal-to-noise_cut-off_for_survey_cluster_completeness : 5.

      sz_selection_function_thetas_file : '/Users/boris/Work/CLASS-SZ/SO-SZ/class_sz/class_sz_auxiliary_files/nemo_sim_thetas_120923_30bins.txt'
      sz_selection_function_skyfracs_file : '/Users/boris/Work/CLASS-SZ/SO-SZ/class_sz/class_sz_auxiliary_files/nemo_sim_skyfracs_120923_30bins.txt'
      sz_selection_function_ylims_file : '/Users/boris/Work/CLASS-SZ/SO-SZ/class_sz/class_sz_auxiliary_files/nemo_sim_ylims_120923_30bins.txt'
      SZ_cat_file: '/Users/boris/Work/CLASS-SZ/SO-SZ/class_sz/class_sz_auxiliary_files/SZ_cat_nemosimkit_130923.txt'

      bin_z_min_cluster_counts : 0.0
      bin_z_max_cluster_counts : 2.0
      bin_dz_cluster_counts : 0.1

      bin_dlog10_snr : 0.25
      log10_snr_min : 0.6
      log10_snr_max : 2.




      dlny : 0.2
      lnymin : -13.
      lnymax : -6.
      dlnM_cluster_count_completeness_grid : 0.1


      cluster_count_completeness_grid_z_cutoff_low : 0.4
      cluster_count_completeness_grid_z_cutoff_mid : 1.

      dz_cluster_count_completeness_grid_low_z : 1e-3
      dz_cluster_count_completeness_grid_mid_z : 1e-2
      dz_cluster_count_completeness_grid_high_z : 1e-1



      mass_epsrel_cluster_counts : 1e-6
      mass_epsabs_cluster_counts : 1e-40

      redshift_epsrel_cluster_counts : 1e-6
      redshift_epsabs_cluster_counts : 1e-40

      B_ym  : 0.08
      C_ym : 0.
      m_pivot_ym_[Msun] : 4.25e14

      use_m500c_in_ym_relation : 0
      use_m200c_in_ym_relation : 1
      use_planck_binned_proba : 0
      use_skyaveraged_noise: 0

      szcc_dof: 3.
      szcc_qtrunc: 2.

      HMF_prescription_NCDM: 1
      no_spline_in_tinker: 1

prior:
  tenToA0_prior: 'lambda tenToA0: stats.norm.logpdf(tenToA0, loc=1.9e-5, scale=9.5e-7)'

stop_at_error: True
timing: True
